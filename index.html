<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Analytics Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <style>
        body {
            padding-top: 20px;
            background-color: #f8f9fa;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-header {
            background-color: #343a40;
            color: white;
            font-weight: bold;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            background-color: #fff;
            border-bottom-color: #fff;
        }
        .flagged-customer {
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .flagged-customer:hover {
            background-color: #f8f9fa;
        }
        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffecb5;
        }
        .btn-ban {
            background-color: #dc3545;
            color: white;
        }
        .banned {
            background-color: #f8d7da !important;
            color: #721c24;
        }
        #productChart {
            height: 300px;
            margin-top: 15px;
        }
        .badge-returns {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Business Analytics Dashboard</h1>
        
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="returns-tab" data-bs-toggle="tab" data-bs-target="#returns" type="button" role="tab">Flagged Customers</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sales-tab" data-bs-toggle="tab" data-bs-target="#sales" type="button" role="tab">Product Sales Analysis</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="recommendations-tab" data-bs-toggle="tab" data-bs-target="#recommendations" type="button" role="tab">Product Recommendations</button>
            </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
            <!-- Flagged Customers Tab -->
            <div class="tab-pane fade show active" id="returns" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Customers with Excessive Returns</span>
                        <div>
                            <label for="minReturns" class="me-2">Min. Returns:</label>
                            <input type="number" id="minReturns" class="form-control-sm" value="5" min="1" style="width: 60px;">
                            <button id="refreshFlagged" class="btn btn-sm btn-primary ms-2">Refresh</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Customer ID</th>
                                        <th>Return Invoices</th>
                                        <th>Items Returned</th>
                                        <th>Last Return Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="flaggedCustomersTable">
                                    <tr>
                                        <td colspan="5" class="text-center">Loading data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3 d-none" id="customerDetailCard">
                    <div class="card-header">
                        Customer Detail: <span id="customerDetailId"></span>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <strong>Warning:</strong> This customer has a high number of returns. Consider reviewing their purchase history.
                        </div>
                        <h5>Purchase History</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Purchase Date</th>
                                    </tr>
                                </thead>
                                <tbody id="customerProductsTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Product Sales Analysis Tab -->
            <div class="tab-pane fade" id="sales" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Top Selling Products by Month</span>
                        <div class="d-flex align-items-center">
                            <select id="yearSelect" class="form-select form-select-sm me-2" style="width: 100px;">
                            </select>
                            <select id="monthSelect" class="form-select form-select-sm me-2" style="width: 120px;">
                            </select>
                            <button id="loadProducts" class="btn btn-sm btn-primary">Load</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="productChart"></div>
                        <div class="table-responsive mt-3">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Stock Code</th>
                                        <th>Product Description</th>
                                        <th>Quantity Sold</th>
                                    </tr>
                                </thead>
                                <tbody id="topProductsTable">
                                    <tr>
                                        <td colspan="4" class="text-center">Select a month and year to view data</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Product Recommendations Tab -->
            <div class="tab-pane fade" id="recommendations" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Product Combination Recommendations</span>
                        <div>
                            <button id="generateRecommendations" class="btn btn-sm btn-primary">Generate Recommendations</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <p>These recommendations show products that are frequently purchased together. Use these insights for product placements, bundles, and targeted marketing.</p>
                        </div>
                        <div class="accordion" id="recommendationsAccordion">
                            <div class="text-center py-4" id="recommendationsLoading">
                                Click "Generate Recommendations" to analyze product combinations
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Banning Customer -->
    <div class="modal fade" id="banCustomerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Ban Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to ban customer <strong id="banCustomerId"></strong>?</p>
                    <p>This will prevent the customer from making further purchases.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmBan">Ban Customer</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.35.0/apexcharts.min.js"></script>
    
    <script>
        // Store banned customers
        const bannedCustomers = new Set();
        let chart = null;
        
        // Load flagged customers on page load
        $(document).ready(function() {
            loadFlaggedCustomers();
            loadTimePeriods();
            
            // Tab change event
            $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
                if (e.target.id === 'sales-tab' && chart) {
                    chart.render();
                }
            });
            
            // Event handlers
            $('#refreshFlagged').click(loadFlaggedCustomers);
            $('#loadProducts').click(loadTopProducts);
            $('#generateRecommendations').click(loadRecommendations);
            
            // Handle ban customer confirmation
            $('#confirmBan').click(function() {
                const customerId = $('#banCustomerId').text();
                bannedCustomers.add(parseInt(customerId));
                $('#banCustomerModal').modal('hide');
                
                // Update UI to show customer is banned
                $(`.flagged-customer[data-id="${customerId}"]`).addClass('banned');
                $(`.ban-button[data-id="${customerId}"]`).text('Banned').prop('disabled', true);
            });
        });
        
        // Load flagged customers with excessive returns
        function loadFlaggedCustomers() {
            const minReturns = $('#minReturns').val();
            
            fetch('/get_flagged_customers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ min_returns: minReturns }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    $('#flaggedCustomersTable').html('<tr><td colspan="5" class="text-center">No customers found with excessive returns</td></tr>');
                    return;
                }
                
                let html = '';
                data.forEach(customer => {
                    const isBanned = bannedCustomers.has(customer.CustomerID);
                    html += `
                        <tr class="flagged-customer ${isBanned ? 'banned' : ''}" data-id="${customer.CustomerID}">
                            <td>${customer.CustomerID}</td>
                            <td><span class="badge bg-danger">${customer.ReturnInvoices}</span></td>
                            <td>${customer.ItemsReturned}</td>
                            <td>${new Date(customer.LastReturnDate).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-sm btn-info view-customer" data-id="${customer.CustomerID}">View Details</button>
                                <button class="btn btn-sm btn-ban ban-button" data-id="${customer.CustomerID}" ${isBanned ? 'disabled' : ''}>${isBanned ? 'Banned' : 'Ban Customer'}</button>
                            </td>
                        </tr>
                    `;
                });
                
                $('#flaggedCustomersTable').html(html);
                
                // Add event handlers for buttons
                $('.view-customer').click(function() {
                    const customerId = $(this).data('id');
                    showCustomerDetails(customerId);
                });
                
                $('.ban-button').click(function() {
                    const customerId = $(this).data('id');
                    $('#banCustomerId').text(customerId);
                    $('#banCustomerModal').modal('show');
                });
            })
            .catch(error => {
                console.error('Error:', error);
                $('#flaggedCustomersTable').html('<tr><td colspan="5" class="text-center text-danger">Error loading data</td></tr>');
            });
        }
        
        // Show customer details
        function showCustomerDetails(customerId) {
            $('#customerDetailId').text(customerId);
            $('#customerDetailCard').removeClass('d-none');
            
            fetch('/get_products', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    customer_id: customerId,
                    sort_by: "date",
                    order: "desc"
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    $('#customerProductsTable').html('<tr><td colspan="2" class="text-center">No products found</td></tr>');
                    return;
                }
                
                let html = '';
                data.forEach(product => {
                    html += `
                        <tr>
                            <td>${product.Description}</td>
                            <td>${new Date(product.InvoiceDate).toLocaleDateString()}</td>
                        </tr>
                    `;
                });
                
                $('#customerProductsTable').html(html);
            })
            .catch(error => {
                console.error('Error:', error);
                $('#customerProductsTable').html('<tr><td colspan="2" class="text-center text-danger">Error loading products</td></tr>');
            });
        }
        
        // Load available time periods
        function loadTimePeriods() {
            fetch('/get_time_periods')
            .then(response => response.json())
            .then(data => {
                // Populate year select
                const years = [...new Set(data.map(p => p.year))];
                let yearOptions = '';
                years.forEach(year => {
                    yearOptions += `<option value="${year}">${year}</option>`;
                });
                $('#yearSelect').html(yearOptions);
                
                // Populate month select
                updateMonthSelect(data, years[0]);
                
                // Add event listener for year change
                $('#yearSelect').change(function() {
                    updateMonthSelect(data, parseInt($(this).val()));
                });
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        // Update month select based on selected year
        function updateMonthSelect(timeData, selectedYear) {
            const months = timeData.filter(p => p.year === selectedYear);
            let monthOptions = '';
            months.forEach(month => {
                monthOptions += `<option value="${month.month}">${month.month_name}</option>`;
            });
            $('#monthSelect').html(monthOptions);
        }
        
        // Load top products for selected month/year
        function loadTopProducts() {
            const year = $('#yearSelect').val();
            const month = $('#monthSelect').val();
            
            fetch('/get_top_products', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    year: year,
                    month: month,
                    top_n: 10
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    $('#topProductsTable').html('<tr><td colspan="4" class="text-center">No sales data found for this period</td></tr>');
                    if (chart) {
                        chart.updateOptions({
                            series: [{
                                name: 'Quantity Sold',
                                data: []
                            }],
                            xaxis: {
                                categories: []
                            }
                        });
                    }
                    return;
                }
                
                let html = '';
                const chartData = [];
                const categories = [];
                
                data.forEach((product, index) => {
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${product.StockCode}</td>
                            <td>${product.Description}</td>
                            <td>${product.Quantity}</td>
                        </tr>
                    `;
                    
                    // Prepare chart data (limit to top 5 for better visualization)
                    if (index < 5) {
                        chartData.push(product.Quantity);
                        categories.push(product.Description.length > 20 ? 
                                        product.Description.substring(0, 20) + '...' : 
                                        product.Description);
                    }
                });
                
                $('#topProductsTable').html(html);
                
                // Initialize or update chart
                if (chart) {
                    chart.updateOptions({
                        series: [{
                            name: 'Quantity Sold',
                            data: chartData
                        }],
                        xaxis: {
                            categories: categories
                        }
                    });
                } else {
                    const options = {
                        series: [{
                            name: 'Quantity Sold',
                            data: chartData
                        }],
                        chart: {
                            type: 'bar',
                            height: 300
                        },
                        plotOptions: {
                            bar: {
                                horizontal: false,
                                columnWidth: '55%',
                                endingShape: 'rounded'
                            },
                        },
                        dataLabels: {
                            enabled: false
                        },
                        xaxis: {
                            categories: categories,
                            labels: {
                                style: {
                                    fontSize: '12px'
                                }
                            }
                        },
                        title: {
                            text: `Top Selling Products - ${$('#monthSelect option:selected').text()} ${year}`,
                            align: 'center'
                        },
                        fill: {
                            colors: ['#4e73df']
                        }
                    };
                    
                    chart = new ApexCharts(document.querySelector("#productChart"), options);
                    chart.render();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                $('#topProductsTable').html('<tr><td colspan="4" class="text-center text-danger">Error loading data</td></tr>');
            });
        }
        
        // Load product recommendations
        function loadRecommendations() {
            $('#recommendationsLoading').html('<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>');
            
            fetch('/get_product_recommendations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    min_support: 0.01,
                    min_confidence: 0.3
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    $('#recommendationsAccordion').html('<div class="alert alert-info">No strong product associations found in the data.</div>');
                    return;
                }
                
                let html = '';
                data.forEach((rec, index) => {
                    const ifProducts = rec.if_purchased.join(', ');
                    const thenProducts = rec.recommend.join(', ');
                    
                    html += `
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading${index}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                                    <strong>If customers buy:</strong> ${ifProducts}
                                </button>
                            </h2>
                            <div id="collapse${index}" class="accordion-collapse collapse" data-bs-parent="#recommendationsAccordion">
                                <div class="accordion-body">
                                    <p><strong>Then they often buy:</strong> ${thenProducts}</p>
                                    <p><strong>Confidence:</strong> ${rec.confidence}% <small class="text-muted">(likelihood of recommendation being followed)</small></p>
                                    <p><strong>Lift:</strong> ${rec.lift} <small class="text-muted">(strength of association, values > 1 indicate strong correlation)</small></p>
                                    <div class="mt-3">
                                        <h6>Recommendation:</h6>
                                        <p>Consider bundling these products or creating a "Frequently Bought Together" section for these items.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                $('#recommendationsAccordion').html(html);
            })
            .catch(error => {
                console.error('Error:', error);
                $('#recommendationsAccordion').html('<div class="alert alert-danger">Error generating recommendations. Please try again.</div>');
            })
            .finally(() => {
                $('#recommendationsLoading').html('');
            });
        }
    </script>
</body>
</html>